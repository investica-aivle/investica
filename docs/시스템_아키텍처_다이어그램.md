# Investica 시스템 아키텍처 다이어그램

## 1. 전체 시스템 아키텍처

```mermaid
graph TB
    subgraph "Frontend (React + TypeScript)"
        A[사용자 인터페이스]
        B[Redux Store]
        C[Stock API Client]
        D[WebSocket Client]
    end
    
    subgraph "Backend (NestJS + Agentica)"
        E[Chat Controller]
        F[KIS Controller]
        G[Stock Controller]
        H[KIS Service]
        I[Trading Provider]
        J[Session Manager]
    end
    
    subgraph "External APIs"
        K[KIS OpenAPI]
        L[OpenAI GPT-4o]
        M[News API]
    end
    
    A --> E
    C --> F
    C --> G
    D --> E
    
    E --> H
    F --> H
    G --> H
    
    H --> I
    H --> J
    
    I --> K
    E --> L
    E --> M
```

## 2. 주식 거래 플로우

```mermaid
sequenceDiagram
    participant User as 사용자
    participant UI as React UI
    participant AI as Agentica AI
    participant KIS as KIS Service
    participant API as KIS OpenAPI
    
    User->>UI: "삼성전자 10주 매수해줘"
    UI->>AI: 자연어 메시지 전송
    
    AI->>AI: 의도 파악 및 함수 선택
    AI->>KIS: buyStock() 호출
    
    KIS->>KIS: 종목명→종목코드 변환
    KIS->>UI: 거래 확인 요청
    UI->>User: 확인 모달 표시
    
    User->>UI: 거래 승인
    UI->>KIS: 승인 응답
    
    KIS->>API: 매수 주문 API 호출
    API->>KIS: 주문 결과 응답
    KIS->>AI: 거래 결과 전달
    AI->>UI: 결과 메시지 표시
```

## 3. 데이터 흐름 다이어그램

```mermaid
flowchart LR
    subgraph "Input Layer"
        A[사용자 입력]
        B[AI 명령]
    end
    
    subgraph "Processing Layer"
        C[의도 파악]
        D[함수 선택]
        E[파라미터 추출]
        F[종목 검색]
        G[거래 확인]
    end
    
    subgraph "API Layer"
        H[KIS 인증]
        I[시세 조회]
        J[주문 실행]
        K[포트폴리오 조회]
    end
    
    subgraph "Output Layer"
        L[마크다운 응답]
        M[UI 업데이트]
        N[에러 처리]
    end
    
    A --> C
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    
    G --> H
    H --> I
    H --> J
    H --> K
    
    I --> L
    J --> L
    K --> L
    L --> M
    L --> N
```

## 4. KIS API 통합 구조

```mermaid
classDiagram
    class KisController {
        +authenticate()
        +buyStock()
        +sellStock()
        +getStockPrice()
        +getPortfolioData()
    }
    
    class KisService {
        +buyStock()
        +sellStock()
        +getStockPrice()
        +convertStockNameToCode()
        +requestTradingConfirmation()
    }
    
    class KisTradingProvider {
        +executeStockOrder()
        +createApiHeaders()
        +parseAccountNumber()
    }
    
    class KisAuthProvider {
        +authenticate()
        +refreshTokenIfNeeded()
        +createApiHeaders()
    }
    
    class SessionManager {
        +createSession()
        +getSessionByKey()
        +removeSession()
    }
    
    KisController --> KisService
    KisService --> KisTradingProvider
    KisService --> KisAuthProvider
    KisController --> SessionManager
```

## 5. Agentica AI 함수 매핑

```mermaid
graph TD
    subgraph "사용자 의도"
        A[매수 요청]
        B[매도 요청]
        C[시세 조회]
        D[포트폴리오 확인]
        E[뉴스 조회]
    end
    
    subgraph "AI 함수"
        F[buyStock]
        G[sellStock]
        H[getStockPrice]
        I[getPortfolioSummary]
        J[getStockDailyPrices]
        K[getKospiPrices]
    end
    
    subgraph "KIS API"
        L[주문 API]
        M[시세 API]
        N[잔고 API]
        O[지수 API]
    end
    
    A --> F
    B --> G
    C --> H
    C --> J
    C --> K
    D --> I
    
    F --> L
    G --> L
    H --> M
    I --> N
    J --> M
    K --> O
```

## 6. 세션 및 인증 관리

```mermaid
stateDiagram-v2
    [*] --> Unauthenticated
    
    Unauthenticated --> Authenticating: KIS 로그인 요청
    Authenticating --> Authenticated: 인증 성공
    Authenticating --> AuthError: 인증 실패
    AuthError --> Unauthenticated: 재시도
    
    Authenticated --> TokenRefresh: 토큰 만료 임박
    TokenRefresh --> Authenticated: 갱신 성공
    TokenRefresh --> Unauthenticated: 갱신 실패
    
    Authenticated --> TradingReady: 거래 준비 완료
    TradingReady --> Executing: 주문 실행
    Executing --> TradingReady: 주문 완료
    
    Authenticated --> Logout: 로그아웃
    Logout --> [*]
```

## 7. 실시간 통신 구조

```mermaid
sequenceDiagram
    participant Client as React Client
    participant WS as WebSocket
    participant Agent as Agentica Agent
    participant KIS as KIS Service
    
    Client->>WS: WebSocket 연결 (세션키 포함)
    WS->>Agent: AI 에이전트 초기화
    
    loop 대화 세션
        Client->>WS: 사용자 메시지
        WS->>Agent: 메시지 처리
        Agent->>Agent: 의도 파악 및 함수 선택
        
        opt 거래 요청인 경우
            Agent->>KIS: 거래 함수 호출
            KIS->>Client: 거래 확인 요청
            Client->>KIS: 사용자 승인/거부
        end
        
        Agent->>WS: 응답 메시지
        WS->>Client: 결과 전송
    end
```

## 8. 에러 처리 및 복구 전략

```mermaid
flowchart TD
    A[API 요청] --> B{인증 상태 확인}
    B -->|만료| C[토큰 갱신]
    B -->|유효| D[API 호출]
    
    C --> E{갱신 성공?}
    E -->|실패| F[로그아웃 처리]
    E -->|성공| D
    
    D --> G{응답 확인}
    G -->|성공| H[결과 반환]
    G -->|실패| I{에러 타입}
    
    I -->|네트워크| J[재시도]
    I -->|인증| K[재로그인 요청]
    I -->|비즈니스| L[에러 메시지 표시]
    
    J --> M{재시도 횟수}
    M -->|한계 초과| L
    M -->|계속| D
    
    F --> N[로그인 페이지]
    K --> N
    L --> O[사용자 알림]
    H --> P[UI 업데이트]
```

## 9. 보안 레이어 구조

```mermaid
graph TB
    subgraph "Frontend Security"
        A[HTTPS 통신]
        B[세션 토큰 관리]
        C[민감 정보 마스킹]
    end
    
    subgraph "Backend Security"
        D[CORS 설정]
        E[세션 가드]
        F[API 키 보호]
        G[요청 검증]
    end
    
    subgraph "External API Security"
        H[KIS OAuth]
        I[API 키 관리]
        J[토큰 자동 갱신]
    end
    
    A --> D
    B --> E
    C --> F
    
    E --> H
    F --> I
    G --> J
```

## 10. 성능 최적화 전략

```mermaid
mindmap
  root((성능 최적화))
    Frontend
      Redux 상태 관리
      컴포넌트 메모이제이션
      지연 로딩
      번들 최적화
    Backend
      세션 캐싱
      API 응답 캐싱
      비동기 처리
      연결 풀링
    Network
      WebSocket 재사용
      HTTP/2 지원
      압축 전송
      CDN 활용
    Database
      인덱스 최적화
      쿼리 최적화
      캐시 전략
      읽기 복제본
```