# Investica 주식 매매 및 시세 관련 로직 분석

## 슬라이드 1: 프레젠테이션 개요
- **제목**: Investica AI 기반 주식 투자 분석 플랫폼
- **부제**: 주식 매매 및 시세 관련 로직 분석
- **목적**: Agentica Framework를 활용한 혁신적 주식 거래 시스템 분석

---

## 슬라이드 2: 시스템 아키텍처 개요

### 전체 시스템 구조
```
Frontend (React + TypeScript)
    ↓
Backend (NestJS + Agentica)
    ↓
KIS OpenAPI (한국투자증권)
```

### 주요 기술 스택
- **Frontend**: React 19.1.0, TypeScript, Vite, Tailwind CSS
- **Backend**: NestJS 11.0.0, Nestia 7.3.0
- **AI**: Agentica Core/RPC 0.30.5, OpenAI GPT-4o-mini
- **외부 API**: 한국투자증권(KIS) OpenAPI

---

## 슬라이드 3: 클라이언트 사이드 주식 API 구조

### 주요 API 엔드포인트 (`client/src/apis/stock.ts`)
```typescript
const stockApi = {
  getTopStocks(): Promise<StockOverviewResponse>
  getStockPrice(company: string): Promise<StockPriceResponse>
  getStockTrades(company: string): Promise<StockTradesResponse>
  getStockDailyPrices(company: string, periodCode?: "D"|"W"|"M"): Promise<StockDailyPricesResponse>
}

export const getKospiPrices = async (params: KospiPricesRequest): Promise<KospiPricesResponse>
```

### 상태 관리 (`client/src/store/slices/tradingSlice.ts`)
```typescript
interface TradingState {
  targetStock: StockInfo | null;
}

// 액션: setTargetStock, clearTargetStock
```

---

## 슬라이드 4: 서버 사이드 KIS API 통합

### KIS Controller (`server/src/controllers/kis/KisController.ts`)
주요 엔드포인트:
- **인증**: `POST /api/kis/auth` - KIS OAuth 인증
- **로그아웃**: `POST /api/kis/logout`
- **시세 조회**: 
  - `POST /api/kis/daily-prices` - 일별 가격
  - `POST /api/kis/kospi-prices` - 코스피 지수
  - `POST /api/kis/stock-price` - 현재가
  - `POST /api/kis/stock-trades` - 체결 정보
- **매매**: 
  - `POST /api/kis/buy` - 매수 주문
  - `POST /api/kis/sell` - 매도 주문
- **포트폴리오**: 
  - `POST /api/kis/portfolio-data` - 전체 포트폴리오
  - `POST /api/kis/portfolio-summary` - 포트폴리오 요약

---

## 슬라이드 5: KIS 거래 데이터 모델

### 주문 요청 인터페이스
```typescript
export interface IOrderRequest {
  stockCode: string & tags.Pattern<"^[0-9]{6}$">;  // 6자리 종목코드
  orderType: "buy" | "sell";                       // 매수/매도
  quantity: number & tags.Type<"uint32"> & tags.Minimum<1>;
  orderCondition: "market" | "limit";              // 시장가/지정가
  price?: number & tags.Type<"uint32"> & tags.Minimum<1>;
}
```

### 주문 응답 인터페이스
```typescript
export interface IOrderResponse {
  success: boolean;
  orderId?: string;    // KIS 주문번호
  message: string;
  errorCode?: string;
}
```

---

## 슬라이드 6: 주식 시세 정보 구조

### 현재가 정보
```typescript
export interface IStockPrice {
  stockCode: string;
  companyName: string;
  currentPrice: number;
  changeAmount: number;    // 전일 대비 변동금액
  changeRate: number;      // 전일 대비 변동률
  volume: number;          // 거래량
  marketCap: number;       // 시가총액
  timestamp: Date;
}
```

### 일별 가격 정보
```typescript
export interface IStockDailyPrice {
  stockCode: string;
  date: Date;
  openPrice: number;   // 시가
  highPrice: number;   // 고가
  lowPrice: number;    // 저가
  closePrice: number;  // 종가
  volume: number;      // 거래량
  adjustPrice: number; // 수정주가
}
```

---

## 슬라이드 7: 포트폴리오 관리 시스템

### 포트폴리오 요약 정보
```typescript
export interface IPortfolioSummary {
  totalValue: number;      // 총 평가금액
  changeAmount: number;    // 평가손익금액
  changePercent: number;   // 평가손익율
  totalInvestment: number; // 총 투자원금
  stockCount: number;      // 보유종목 수
  message: string;         // 요약 메시지
}
```

### 개별 주식 보유 정보
- 보유수량, 매입평균가격, 현재가
- 평가금액, 평가손익금액, 평가손익율
- 전일대비증감, 등락율

---

## 슬라이드 8: KIS 서비스 계층 구조

### KisService (`server/src/providers/kis/KisService.ts`)
핵심 기능:
1. **종목명 → 종목코드 변환**: `convertStockNameToCode()`
2. **거래 확인 요청**: `requestTradingConfirmation()`
3. **매수/매도 실행**: `buyStock()`, `sellStock()`
4. **시세 조회**: `getStockPrice()`, `getStockTrades()`, `getStockDailyPrices()`

### KisTradingProvider
- **주문 실행**: `executeStockOrder()`
- **KIS API 헤더 생성 및 요청 처리**
- **토큰 만료 체크 및 갱신**

---

## 슬라이드 9: Agentica AI 통합

### ChatController (`server/src/controllers/chat/ChatController.ts`)
WebSocket 기반 실시간 AI 상호작용:
```typescript
const agent: Agentica<"chatgpt"> = new Agentica({
  model: "chatgpt",
  vendor: { api: new OpenAI(), model: "gpt-4o-mini" },
  controllers: [
    typia.llm.controller<KisSessionService, "chatgpt">("kis", kisSessionService),
    typia.llm.controller<NewsAgentService, "chatgpt">("news", newsService),
    typia.llm.controller<ReportsService, "chatgpt">("reports", reportsService),
  ]
});
```

### 시스템 프롬프트 설정
- 한국어 응답
- 마크다운 형식 지원
- 금융 용어 자동 설명
- 표 형식 데이터 표현

---

## 슬라이드 10: AI 함수 정의 (KisSessionService)

### 주요 AI 함수들
```typescript
class KisSessionService {
  // 매수 주문
  async buyStock(input: {
    stockName: string;        // "삼성전자"
    quantity: number;         // 10
    orderCondition: "market" | "limit";
    price?: number;           // 75000
  }): Promise<IKisStock.IOrderResponse>

  // 매도 주문
  async sellStock(input: {
    stockName: string;
    quantity: number;
    orderCondition: "market" | "limit";
    price?: number;
  }): Promise<IKisStock.IOrderResponse>

  // 현재가 조회
  async getStockPrice(input: { stockName: string })
  
  // 일별 시세 조회
  async getStockDailyPrices(input: {
    stockName: string;
    periodCode?: "D" | "W" | "M";
    adjustPrice?: 0 | 1;
  })
}
```

---

## 슬라이드 11: 거래 확인 시스템

### 클라이언트 이벤트 인터페이스
```typescript
export interface IClientEvents extends IAgenticaRpcListener {
  onNews(payload: NewsPushPayload): Promise<void> | void;
  onStockFocus(payload: StockInfo): Promise<void> | void;
  onTradingConfirmationRequest(payload: TradingConfirmationRequest): Promise<TradingConfirmationResponse>;
}
```

### 거래 확인 요청 플로우
1. AI가 매수/매도 명령 받음
2. `requestTradingConfirmation()` 호출
3. 클라이언트에 확인 모달 표시
4. 사용자 승인/거부 응답
5. 승인 시 실제 KIS API 호출

---

## 슬라이드 12: 인증 및 세션 관리

### KIS OAuth 인증 프로세스
```typescript
// 1. 인증 요청
interface IKisAuthRequest {
  accountNumber: string;  // 계좌번호
  appKey: string;         // KIS App Key
  appSecret: string;      // KIS App Secret
}

// 2. 세션 생성
interface IKisSessionData {
  accessToken: string;
  appKey: string;
  appSecret: string;
  accountNumber: string;
  expiresAt: Date;
}
```

### 세션 관리 특징
- 메모리 기반 세션 저장
- 토큰 만료 자동 체크 및 갱신
- 마스킹된 정보로 로깅

---

## 슬라이드 13: 실시간 데이터 처리

### WebSocket 통신
- **클라이언트**: `AgenticaRpcProvider.tsx`
- **서버**: `ChatController.ts`
- **프로토콜**: TGrid WebSocket

### 실시간 기능
1. **AI 채팅**: 자연어 명령 → 함수 호출
2. **뉴스 푸시**: 종목별 실시간 뉴스
3. **주식 포커스**: 선택된 종목 정보 동기화
4. **거래 확인**: 실시간 거래 승인 요청

---

## 슬라이드 14: 에러 처리 및 로깅

### 에러 처리 전략
```typescript
// KIS API 에러 응답 처리
interface IKisOrderApiResponse {
  rt_cd: string;      // "0": 성공, 기타: 실패
  msg_cd: string;     // 응답코드
  msg1: string;       // 응답메시지
  output?: IKisOrderOutput[];
}
```

### 로깅 시스템
- **마스킹**: 계좌번호, 세션키, App Key
- **구조화된 로그**: 요청/응답 단계별 기록
- **성능 측정**: 함수 실행 시간 추적

---

## 슬라이드 15: 보안 고려사항

### 현재 구현된 보안 기능
1. **데이터 마스킹**: 민감 정보 로그 보호
2. **세션 기반 인증**: Bearer 토큰 방식
3. **CORS 설정**: 허용된 도메인만 접근
4. **토큰 만료 관리**: 자동 갱신 및 검증

### 실제 서비스 적용 시 필요사항
- 강화된 인증/보안 시스템
- 개인정보 보호 및 데이터 암호화
- 금융 규제 준수 (전자금융거래법)
- 사용자 자금 보호 시스템

---

## 슬라이드 16: 사용자 경험 개선

### 디지털 소외계층 대상 솔루션
1. **자연어 거래**: "삼성전자 100주 매수해줘"
2. **지능형 화면 전환**: AI가 필요한 화면으로 자동 이동
3. **쉬운 용어 해설**: 금융 용어 자동 감지 및 설명
4. **직관적 정보 제공**: 마크다운 표 형식으로 데이터 표시

### AI 기반 기능
- 투자 보고서 자동 요약
- 산업 분석 리포트 생성
- 코스피 시장 상황 실시간 제공

---

## 슬라이드 17: 핵심 데이터 플로우

### 매수 주문 플로우
```
사용자 음성/텍스트 입력
    ↓
Agentica AI 의도 파악
    ↓
KisSessionService.buyStock() 호출
    ↓
종목명 → 종목코드 변환
    ↓
거래 확인 요청 (UI 모달)
    ↓
사용자 승인 시 KIS API 호출
    ↓
주문 결과 반환 및 UI 업데이트
```

### 시세 조회 플로우
```
AI 함수 호출
    ↓
KisService 메서드 실행
    ↓
KIS API 요청 (인증 헤더 포함)
    ↓
응답 데이터 가공
    ↓
마크다운 형식으로 클라이언트 전송
```

---

## 슬라이드 18: 개발 및 배포 환경

### 개발 환경 설정
```bash
# 1. 의존성 설치
cd server && pnpm install
cd client && pnpm install

# 2. 환경 설정
cp server/.env.example server/.env  # KIS API 키 설정
cp client/.env.example client/.env

# 3. 실행
cd server && pnpm start:dev  # 백엔드 서버
cd client && pnpm dev        # 프론트엔드 서버
```

### 주요 설정 파일
- `server/.env`: KIS API 키, OpenAI API 키
- `client/.env`: 백엔드 API URL
- `nestia.config.ts`: API 문서 자동 생성 설정

---

## 슬라이드 19: 성능 최적화

### 클라이언트 최적화
- **Redux Toolkit**: 상태 관리 최적화
- **Vite**: 빠른 번들링 및 HMR
- **TypeScript**: 컴파일 타임 에러 방지

### 서버 최적화
- **Nestia**: 자동 API 문서 생성 및 검증
- **세션 캐싱**: 메모리 기반 빠른 세션 조회
- **비동기 처리**: Promise 기반 병렬 처리

### 모니터링
- 구조화된 로깅 시스템
- 함수 실행 시간 측정
- WebSocket 연결 상태 관리

---

## 슬라이드 20: 확장 가능성 및 결론

### 확장 가능한 아키텍처
1. **마이크로서비스**: 각 기능별 독립적 서비스 분리 가능
2. **다중 브로커 지원**: KIS 외 다른 증권사 API 통합 가능
3. **AI 모델 확장**: GPT 외 다른 LLM 지원 가능
4. **실시간 기능**: WebSocket 기반 확장성

### 주요 성과
- **Agentica Framework 활용**: AI 기반 자연어 거래 구현
- **사용자 친화적 UX**: 복잡한 주식 거래를 간단한 대화로 변환
- **안전한 거래**: 사용자 확인 단계를 통한 실수 방지
- **실시간 정보**: WebSocket 기반 즉시성 확보

### 향후 발전 방향
- 실전 거래 지원을 위한 보안 강화
- 더 정교한 AI 투자 조언 기능
- 모바일 앱 확장
- 기관투자자 대상 기능 추가

---

## 부록: 코드 예시 및 상세 구현

### A1. KIS API 헤더 생성 예시
```typescript
private createApiHeaders(sessionData: IKisSessionData, trId: string): IKisApiHeaders {
  return {
    "content-type": "application/json; charset=utf-8",
    authorization: `Bearer ${sessionData.accessToken}`,
    appkey: sessionData.appKey,
    appsecret: sessionData.appSecret,
    tr_id: trId,
    custtype: "P", // 개인
  };
}
```

### A2. AI 프롬프트 설정
```typescript
systemPrompt: {
  common: () => "당신은 한국투자증권 KIS API를 통해 주식 거래를 도와주는 전문 AI 어시스턴트입니다.",
  describe: (histories) => 
    "**응답 형식 가이드라인:**\n" +
    "- 모든 응답은 마크다운(Markdown) 형식으로 작성하세요.\n" +
    "- 표 작성 시 | (파이프) 기호로 열을 구분하세요.\n" +
    "- 초보 투자자도 이해할 수 있도록 용어 설명을 포함하세요."
}
```
